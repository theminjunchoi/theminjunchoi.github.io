---
title: 커피빵(CoffeeShout) Race Condition 해결
date: 2025-10-15 09:44:21
updated: 2025-10-15 13:13:27
publish: false
tags:
  - 우아한테크코스
  - CoffeeShout
series:
---
## + Race Condition

조회 후 쓰기 작업이 많은 도메인 특성상 Race Condition이 발생할 수 있다. Pub/Sub 메시지 전파에는 약간의 지연(수 밀리초~수십 밀리초)이 존재하기 때문에, 극히 짧은 순간 동안 서로 다른 인스턴스가 다른 게임 상태를 볼 수 있다.

예를 들어 다음과 같은 **동시성 문제**가 발생할 수 있다:

```
상황: 서버 1에 유저 A, 서버 2에 유저 B가 각각 연결된 상태

1. 유저 A, B 모두 "카드 1"이 선택되지 않은 상태를 확인
2. 유저 A와 B가 거의 동시에 "카드 1" 선택 요청 전송
3. 서버 1, 2가 각각 로컬 캐시 기준으로 검증 후 "카드 1 선택" 이벤트 발행
4. 각 서버가 Pub/Sub 메시지를 수신하지만, 수신 순서가 다를 수 있음
5. 결과적으로 서버마다 "카드 1"을 선택한 유저가 다르게 기록됨
```

이는 **분산 환경에서 발생하는 전형적인 Race Condition** 문제다.

### Redis Streams 도입

이 문제를 해결하기 위해 **방 입장**과 **카드 선택** 로직에만 **Redis Streams**를 적용했다.

우리 게임은 다음과 같은 제약 조건이 있다:

- 동일한 닉네임으로 중복 입장 불가
- 이미 선택된 카드는 다른 유저가 선택 불가

기존 Redis Pub/Sub 구조로는 이벤트 순서를 보장할 수 없어 위와 같은 동시성 제어가 불가능했다.

**Redis Streams를 도입한 방식:**

1. 방 입장/카드 선택 이벤트를 Redis Stream에 발행
2. Stream이 이벤트를 **순서대로 보관** (메시지 큐 역할)
3. 각 서버 인스턴스가 **Consumer Group**을 통해 이벤트를 순차적으로 가져감
4. 이벤트를 처리한 인스턴스만 로컬 캐시 업데이트 및 ACK 전송
5. 다른 인스턴스들은 Pub/Sub을 통해 최종 결과만 수신

이를 통해:

- **이벤트 순서 보장**: Stream이 발행 순서대로 이벤트 관리
- **중복 처리 방지**: Consumer Group의 메시지 분배로 단 하나의 인스턴스만 처리
- **메시지 유실 방지**: ACK 기반으로 처리 실패 시 재처리 가능

결과적으로 **동시성이 중요한 로직에만 Redis Streams를 선택적으로 적용**하고, 나머지는 Pub/Sub으로 빠르게 동기화하는 **하이브리드 구조**를 구축했다.

