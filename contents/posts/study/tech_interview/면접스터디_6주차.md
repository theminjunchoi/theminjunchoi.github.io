---
title: 1억명 유저의 비번 관리
date: 2025-02-11 09:44:21
updated: 2025-10-19 20:14:12
publish:
tags:
series:
---
![[스크린샷 2025-10-18 오후 5.49.35.png]]

## 문제 분석

### 1억 계정 규모 계산
- 1억 명 * 평균 히스토리 10개 = **10억개의 password_history**
- history 평균 크기: user_id(12) + password_hash(64) + timestamp(8) + 기타 = **100바이트**
- 총 데이터 크기: **100GB**

### 일일 비밀번호 변경 건수 추정
- 일반적으로 월 1-2% 사용자가 비밀번호 변경 가정
- 1억 * 1.5% / 30일 = 매일 약 5만건의 변경
- 초당 10 ~ 20건

## 각 요구사항별 성능분석

### 1. 최근 5개 비밀번호 체크
```sql
SELECT password_hash FROM password_history 
WHERE user_id = ? 
ORDER BY created_at DESC 
LIMIT 5;
```

- 인덱스 `(user_id, created_at DESC)`  타면서 스캔
- B-tree 인덱스에서 O(log n) + 5레코드 읽기 = 1-5ms
- **문제없음**

### 2. 3개월 이내 사용 체크
```sql
SELECT password_hash FROM password_history 
WHERE user_id = ? 
AND created_at > DATE_SUB(NOW(), INTERVAL 3 MONTH);
```
- 복합 인덱스 `(user_id, created_at DESC)` 타면서 스캔
- 3개월치만 읽고 애플리케이션에서 비교
- 1유저당 최대 3개월에 2-3번 변경 → 2-3레코드 확인
- 문제없음

### 3. 100번 이상 사용됐는지 체크 (⭐️)
```sql
SELECT COUNT(*) FROM users WHERE current_password_hash = ?;
```
- 1억 레코드에서 스캔 필요
- 1억건이면 10~20초 소요 
- 문제많음

#### 실제 내 프로젝트였다면?
- 과연 굳이 "100번 이상 사용됐는지" 체크해야하나... 의심
- 기획팀에게 요구사항 완화 요청
	- 이게 가장 시간적, 경제적 비용을 줄일 수 있는 방법이지 않나
- 정 안되면 정확히 100번 카운트를 해야햐나?
	- 90번이든 110개든 보안 효과가 비슷하면 되는 거 아닌가?

#### 근사치 기반
```java
private BloomFilter<String> popularPasswordFilter;

public void initBloomFilter() {
	popularPasswordFilter = BloomFilter.create(
		// 100만개의 데이터, 1% False Positive Rate 설정
	);
}

public Boolean validate (String password) {

	String hash = hash(password);

	// ...
	
	if (popularPasswordFilter.mightContain(hash)) {
		return false;
	}
	
	return true;
}
```
- 조회 성능 O(1)
- 추가 인프라 필요 없음 (비용 필요없음)

#### 더 정확히 체크해야한다면?
- Redis에 집계 테이블 저장, 매일 새벽에 1번씩 업데이트
- 아닌가? 새벽에 1번씩 Redis를 업데이트 하고 계속 Redis에 접근해서 조회해야한다면, 그냥 DB에 집계 테이블 만들어두고 새벽에 DB 접근해서 로컬 캐시 업데이트 해놓을듯 

---

## Claude가 말한 보완점
- 샤딩 전략 없음
	- 1억 유저면 단일 DB로 못 버팀
		- 근데 배민이었나, 토스였나, 쿠팡이었나? 아직 성능좋은 단일 DB로 버틴다고 들음
- Redis의 집게 테이블은 어떻게 동기화할거냐
	- CDC 써서 실시간 동기화하면 더 정확해짐
- Redis에 접근할 때 동시성 이슈 터지면 어떻게 할거냐
	- update와 select 동시에 일어나면 어떻게 할거임?
		- 아니 근데 비번 변경이 동시에 일어날 일이 그렇게 많나?